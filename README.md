# FP_pgexam

## 内容

転用防止のため割愛

## 実行環境

```sh
%cat /etc/lsb-release
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=18.04
DISTRIB_CODENAME=bionic
DISTRIB_DESCRIPTION="Ubuntu 18.04.2 LTS"
%ruby --version
ruby 2.5.3p105 (2018-10-18 revision 65156) [x86_64-linux]
```

## インストール・実行方法

```sh
%git clone git@github.com:Phantasmanoria/FP_pgexam.git
%cd FP_pgexam 
%ruby run.rb
```

## 使い方

```sh
%ruby run.rb --help
Usage: run [options]
    -f [FILE,FILE,...]               input files (default:sample.log)
    -m [MODE]                        mode (HOUR | HOST | BOTH) (default:BOTH)
    -t [STARTTIME-ENDTIME]           time interval per hour(e.g. 2014040100-2019033123)(def:all)
    -s                               save memory mode (default:off)
```

### ファイルオプション(-f)

デフォルトではrun.rbと同じ場所にある`sample.log`に指定されてます.  
読み込みを行うファイルの指定が出来ます.  
複数のファイルから読み込む時は`,`で繋げて記入してください.  

### モードオプション(-m)

デフォルトでは`BOTH`に指定されています.  
`HOUR`は各時間帯毎のアクセス件数を表示させる機能です(0件の場合は表示しません).  
`HOST`はリモートホスト毎のアクセス件数を多い順に表示させる機能です.  
`BOTH`は2つの機能をどちらも実行します.  
両方実行させてみた時の例はこのようになります. 

```sh
%ruby run.rb
date              |Access times
-------------------------------
2005年04月18日00時|3
2005年04月18日01時|2
2005年04月18日08時|1
2005年04月18日10時|1
2019年12月22日15時|7
Host name      |Access times
----------------------------
 90.200.300.400|3
      102.2.3.4|2
     104.28.3.4|1
      10.2.3.40|1
 60.144.122.105|1
  32.168.102.89|1
 168.198.183.62|1
 200.51.221.124|1
 28.144.128.170|1
 120.81.204.164|1
   176.42.77.81|1
```


### タイムオプション(-t)

デフォルトでは`全期間`に指定されています.  
アクセス件数を表示させるための期間を`時`までの指定で設定できます.  
`-`で区切って開始時間と終了時間を設定してください(例:2014040100-2019033123).  
また, 終了時刻は**指定した時の59分まで**なので注意してください.  
<br>
例えば以下の時間の指定は以下のようになります.  

```
2014年4月1日0時 -> 2014 04 01 00 -> 2014040100
```

また, この日時に関して, ある程度省略が可能です.  
今日が2019年12月25日だとして, 今月の15日0時から20日20時までの時間を設定したいなら,  
日付からのみを書いた`1500-2019`でも有効です.  
この省略は`時`から(2桁), `日`から(4桁), `月`から(6桁)が可能です(逆はありません).  

### save memoryオプション(-s)

デフォルトでは`off`に指定しています.  
メモリ消費を抑えるような設定になっています.  
途中の処理内容のファイル書き出しを行うので, 入力ファイルのサイズ以上の空きを用意してください.  


## save memoryの実現について

### 方針

計算した結果の途中を複数に分割しつつ一時保存し, 再度読み込みを行うことで回避を試行してます.  
基本的に読み込む時は一行ずつ読み込みを行うことでメモリ消費を回避してます.  
一時保存時に分割したのはファイル全体を読み込む時があっても対応できるようにするためです.  

### 分割したデータ全体からソートを行う(`Save.unify_sort`)の構成について

簡潔に言うと, 各分割ファイル(各ソート済前提)の各一番上の項目,つまり表示候補`candidate`を集めて比較を行い,
一番最初に表示すべき内容`top`と同一の`candidate`達がもつアクセス数を統合し, 表示しています.  
なお, 一度表示した`candidate`を持っていたファイルの読み込み行を1つずらすことで, 次の候補を表示させています.  

実践的なイメージとして以下の内容を想定します(`input_line`は各変数の配列番号).  

``` perl
input_line = [0,0,0]
file1 = [ 100, 80, 20 ]
file2 = [ 80, 30, 20 ]
file3 = [ 100, 50, 30 ]
```

最初の候補は`input_line`によって`100,80,100`となり, ここの最大は`100`なので`100が2個ある`と理解できます.  
理解し終えると, `100`が入っていたのは`file1`と`file3`なので`input_line`の1番目と三番目を+1します.  
ここで, 次の候補を出そうとすると, 更新された`input_line`によって`80 80 50`となり, `80が2個ある`と理解できます.  
このように繰り返すことで`100が2個, 80が2個, 50が1個, 30が2個, 20が2個`と求めることが出来ます.  

時間毎の表示に関してはこれを一度行うのみで完了できます.  
ただし, ホスト数を昇順で並べるには一度この動作を行い, 個数が統合された状態でアクセス数を基準にもう一度
ソートしなおしてから出力する必要があるので, これを二度実行しています.  
その役割のスイッチを担っているのがプログラム内変数`tmp`になります.  
`tmp`のtrue時は動作結果の保存, false時は動作結果の出力を行うようにしています.  

## TODO(改善可能点)

- 全体
  - [DONE]eval多すぎ
	- ハッシュのkeyに使用している
	- 配列にすると呼び出しが忙しい上に余計メモリ消費が起きる
  - [SKIP]変数名同じの多すぎ
	- 同じ時は意味は同じにしている
	- クラス名やインスタンス名については宣言時に判別可能と判断
  - [DONE]関数に渡す前と後で変数名違う
	- その時の意味で変数名変更してる
  - [SKIP]analysisとdisplayをrun内でできるように
    - 分岐を考えると分析をrunで見えるように一度戻すよりこのままのほうがワークフロー的に良いと判断
  - ログ出力機能の実装(プラス項目)
	- 外部からコマンド割り込みさせる方が良さそう
	- shell上ならリダイレクトで解決では(それ言ったらおしまい)
  - クラス分割しすぎでは
    - 結構思う
  - [SKIP]そもそもメモリ浪費しやすいRubyなのは...
	- 気にしない
- input.rb
  - [DONE]時間以外の入力チェック
    - 想定外ファイルが来た時にマッチングが失敗するのでnil分岐で対処
- opt.rb
  - run内のoptの渡し方が単体はおかしい
    - 全部渡しても良いが...
- convert.rb
  - [SKIP]日時変換のJST以外の対応
	- 受信時刻はホスト依存(リモードではない?)
- opt.rb
  - 日時の存在確認
- save.rb
  - [SKIP]unify_sortが壊滅的に汚い
	- 別メソッド化しても良かったが大半被る為
  - [DONE]破壊的メソッドの使用(メモリ消費対策)
	- save memory時は変換するように設定
  - [DONE]継承無しで使えるかどうか(設計から)
	- 継承してるけどあんまり意味ない現実はある -> 一部は引き継ぐ
	- 継承後の内容もある程度統合できそう -> しました
- analysis.rb
  - [DONE]機能統合(宣言をeval以外で行えるように)
	- eval回避は出来なかったが統合できた
  

